<#
.SYNOPSIS
    Performs general post deployment cleanup using CWC library

    Copyright (c) Citrix Systems, Inc. All Rights Reserved.
.DESCRIPTION
    
.Parameter SVCAccount
    General Service account user name to be removed from local admin group
.Parameter DNSDomainName
    Domain DNS name for SVCAccount
.Parameter LocalMediaLocation
    Local path for temp files to be cleaned up, defaults to user's temp directory
#>
[CmdletBinding()]
param(
    [Parameter(Mandatory=$true)][string] $SVCAccount,
    [Parameter(Mandatory=$true)][string] $DNSDomainName,
    [Parameter(Mandatory=$false)][string] $LocalMediaLocation = (Join-Path -Path $ENV:Temp -ChildPath "Citrix")
)

try {
    # Clean up the temp directory
    Write-Verbose "Cleaning up the temp directory"
        
        Remove-Item $LocalMediaLocation -Force -Recurse -Verbose -ErrorAction SilentlyContinue
        Remove-Item $LocalMediaLocation -Force -Recurse -Verbose -ErrorAction SilentlyContinue

    # Removing the Service Account from the local admin group
    Write-Host "Removing the Service Account from the local admin group"
        
        $SVCAccount = cwcTools\New-UQUserName -UserName $SVCAccount -verbose
        cwcActive-Directory\Remove-LocalAdministrator -ObjectType User -ObjectName $SVCAccount -DNSDomainName $DNSDomainName -verbose

    # Remove CWC module library and Fix PSModulePath
    Write-Host "Remove CWC module library files and update the PSModulePath"
        
        Remove-Item "$env:programfiles\common files\Modules\cwc*" -Recurse -Force -Verbose
                
        $MachinePSPath = $([Environment]::GetEnvironmentVariable("PSModulePath","Machine")).split(";")
        $MachinePSPathNew = ""
        foreach ($path in $MachinePSPath) {
            if ($path.toLower().Contains("c:\program files\common files\modules\cwc")) {}
            else {
                $MachinePSPathNew += "$path;"
            }
        }
        [Environment]::SetEnvironmentVariable("PSModulePath", $MachinePSPathNew, "Machine")
}
catch {
    $Error[0]
    exit 1
}